<template lang="pug">
  template-setting-item.malware-protection(
    :title="$t('v2.merakiTemplates.malwareProtection')"
    :operation-mode="operationMode"
    :customizations="customizations"
    :setting-fields="[field_key]"
    customizations-enabled
    @customizationsClick="$emit('customizationsClick', $event)"
  )
    template(v-slot:default)

      v-layout(row wrap).template-setting-item__content__row
        v-flex(xs6 md4 lg3 xl2)
          label {{ $t('v2.merakiTemplates.mode') }}
        v-flex(xs6 md4 lg3 xl2)
          base-select(
            :items="modes"
            :value="effectiveValue.mode"
            @input="onFieldInput('mode', $event)"
            :disabled="isFixed"
            :validations="{ required: isTemplateMode }"
            :suppress-validation-state-display="isEmpty"
            clearable
          )

      v-layout(
        v-show="effectiveValue.mode !== 'disabled'"
        row wrap
      ).template-setting-item__content__row
        v-flex(xs6 md4 lg3 xl2)
          label {{ $t('v2.merakiTemplates.allowedURLs') }}
        v-flex(xs6 md8 lg9 xl10)
          .malware-protection__allowed-url(
            v-for="(allowedUrlItem, index) in allowedURLs"
            :key="index"
          )
            v-layout(row wrap)
              v-flex(xs5)
                base-text-input(
                  :value="allowedUrlItem.url"
                  @input="onURLFieldInput('url', index, $event)"
                  :validations="{ required: true }"
                  :suppress-validation-state-display="isEmpty"
                  :disabled="isFixed"
                  :placeholder="$t('v2.placeholders.url')"
                  @focus="fetchFieldSuggestions(field_key, 'allowedUrls__url')"
                  :suggestions="getFieldSuggestions(field_key, 'allowedUrls__url')"
                )
              v-flex(
                v-if="isTemplateMode"
                xs5 offset-xs1
              )
                base-text-input(
                  :value="allowedUrlItem.comment"
                  @input="onURLFieldInput('comment', index, $event)"
                  :disabled="isFixed"
                  :placeholder="$t('wifi.comment')"
                )

            .malware-protection__allowed-url__actions(
              v-if="!isFixed"
            )
              v-icon.malware-protection__allowed-url__actions__action(
                @click="onDeleteURLClick(index)"
              ) $vuetify.icons.delete

          span.malware-protection__add-chart-item-trigger(
            v-if="!isFixed"
            @click="onAddURLClick"
          ) + {{ $t('general.addNew') }}

      v-layout(
        v-show="effectiveValue.mode !== 'disabled'"
        row wrap
      ).template-setting-item__content__row
        v-flex(xs6 md4 lg3 xl2)
          label {{ $t('v2.merakiTemplates.allowedFiles') }}
        v-flex(xs6 md8 lg9 xl10)
          .malware-protection__allowed-file(
            v-for="(allowedFileItem, index) in allowedFiles"
            :key="index"
          )
            v-layout(row wrap)
              v-flex(xs5)
                .malware-protection__allowed-file__file-selection
                  base-file-input(
                    v-if="!isFixed"
                    @input="onAllowedFileSelect(index, $event)"
                  )
                  .malware-protection__allowed-file__file-selection__hash-info(
                    v-if="allowedFileItem.sha256"
                  )
                    span {{ $t('v2.merakiTemplates.fileHash') }}
                    span {{ allowedFileItem.sha256 }}

              v-flex(
                v-if="isTemplateMode"
                xs5 offset-xs1
              )
                base-text-input(
                  :value="allowedFileItem.comment"
                  @input="onFileFieldInput('comment', index, $event)"
                  :disabled="isFixed"
                  :placeholder="$t('wifi.comment')"
                )

            .malware-protection__allowed-file__actions(
              v-if="!isFixed"
            )
              v-icon.malware-protection__allowed-file__actions__action(
                @click="onDeleteFileClick(index)"
              ) $vuetify.icons.delete

          span.malware-protection__add-chart-item-trigger(
            v-if="!isFixed"
            @click="onAddFileClick"
          ) + {{ $t('general.addNew') }}

</template>

<script>
import _ from 'lodash'
import TemplateSettingItem from './template-setting-item'
import NetworkTemplateSettingItemMixin from '@/mixins/network-template-setting-item.mixin'
import CurrentNodeSelectionsMixin from '@/mixins/current-node-selections.mixin'
import BaseTextInput from '@/components/v2/base-text-input/base-text-input'
import BaseSelect from '@/components/v2/base-select/base-select'
import BaseFileInput from '@/components/v2/base-file-input/base-file-input'
import { sha256 } from 'js-sha256'

export default {
  name: 'malware-protection',
  mixins: [
    NetworkTemplateSettingItemMixin,
    CurrentNodeSelectionsMixin
  ],
  components: {
    BaseFileInput,
    BaseTextInput,
    BaseSelect,
    TemplateSettingItem
  },
  data: function () {
    return {
      field_key: 'malware_settings',
      modes: [
        {
          key: 'enabled',
          name: this.$t('general.enabled')
        },
        {
          key: 'disabled',
          name: this.$t('general.disabled')
        }
      ],
      computeCounter: 0
    }
  },
  computed: {
    emptyValue () {
      return {
        mode: null
      }
    },
    nonConfiguredValue () {
      return {}
    },
    isAllowedURLsEmpty () {
      return this.isEmpty || _.isNil(this.settingValue.allowedUrls) || _.isEmpty(this.settingValue.allowedUrls)
    },
    allowedURLs () {
      // eslint-disable-next-line no-unused-expressions
      this.computeCounter

      return !this.isAllowedURLsEmpty ? this.settingValue.allowedUrls : [this.getEmptyURLItem()]
    },
    isAllowedFilesEmpty () {
      return this.isEmpty || _.isNil(this.settingValue.allowedFiles) || _.isEmpty(this.settingValue.allowedFiles)
    },
    allowedFiles () {
      // eslint-disable-next-line no-unused-expressions
      this.computeCounter

      return !this.isAllowedFilesEmpty ? this.settingValue.allowedFiles : [this.getEmptyFileItem()]
    }
  },
  methods: {
    getEmptyURLItem () {
      return {
        url: null,
        comment: null
      }
    },
    addURLItem (item) {
      this.$emit('settingInput', this.field_key, {
        ...(this.settingValue ? this.settingValue : {}),
        allowedUrls: [
          ...(!this.isAllowedURLsEmpty ? this.settingValue.allowedUrls : []),
          item
        ]
      })
    },
    onAddURLClick () {
      if (this.isAllowedURLsEmpty) {
        // Do twice if the list is already empty, as one item is displayed as placeholder already
        this.addURLItem(this.getEmptyURLItem())
      }

      this.addURLItem(this.getEmptyURLItem())
    },
    onDeleteURLClick (index) {
      if (this.isAllowedURLsEmpty) {
        this.computeCounter += 1 // Force re-compute of table items so that row re-renders
        return
      }

      this.$emit('settingInput', this.field_key, {
        ...(this.settingValue ? this.settingValue : {}),
        allowedUrls: this.settingValue.allowedUrls.filter((item, itemIndex) => index !== itemIndex)
      })
    },
    onURLFieldInput (field, index, value) {
      // If inputted a value for placeholder item, add it to the list of items first
      if (this.isAllowedURLsEmpty) {
        this.addURLItem(this.getEmptyURLItem())
      }

      this.$emit('settingInput', this.field_key, {
        ...(this.settingValue ? this.settingValue : {}),
        allowedUrls: this.settingValue.allowedUrls.map((item, itemIndex) => {
          if (index === itemIndex) {
            return {
              ...item,
              [field]: value
            }
          }

          return item
        })
      })
    },
    getEmptyFileItem () {
      return {
        sha256: null,
        comment: null
      }
    },
    addFileItem (item) {
      this.$emit('settingInput', this.field_key, {
        ...(this.settingValue ? this.settingValue : {}),
        allowedFiles: [
          ...(!this.isAllowedFilesEmpty ? this.settingValue.allowedFiles : []),
          item
        ]
      })
    },
    onAddFileClick () {
      if (this.isAllowedFilesEmpty) {
        // Do twice if the list is already empty, as one item is displayed as placeholder already
        this.addFileItem(this.getEmptyFileItem())
      }

      this.addFileItem(this.getEmptyFileItem())
    },
    onDeleteFileClick (index) {
      if (this.isAllowedFilesEmpty) {
        this.computeCounter += 1 // Force re-compute of table items so that row re-renders
        return
      }

      this.$emit('settingInput', this.field_key, {
        ...(this.settingValue ? this.settingValue : {}),
        allowedFiles: this.settingValue.allowedFiles.filter((item, itemIndex) => index !== itemIndex)
      })
    },
    onAllowedFileSelect (index, value) {
      const reader = new FileReader()
      const _this = this

      reader.onload = function () {
        const binaryString = reader.result
        const fileHash = sha256(binaryString)

        _this.onFileFieldInput('sha256', index, fileHash)
      }
      reader.readAsBinaryString(value)
    },
    onFileFieldInput (field, index, value) {
      // If inputted a value for placeholder item, add it to the list of items first
      if (this.isAllowedFilesEmpty) {
        this.addFileItem(this.getEmptyFileItem())
      }

      this.$emit('settingInput', this.field_key, {
        ...(this.settingValue ? this.settingValue : {}),
        allowedFiles: this.settingValue.allowedFiles.map((item, itemIndex) => {
          if (index === itemIndex) {
            return {
              ...item,
              [field]: value
            }
          }

          return item
        })
      })
    },
    onFieldInput (field, value) {
      this.$emit('settingInput', this.field_key, {
        ...this.effectiveValue,
        [field]: value
      })
    }
  }
}
</script>

<style scoped lang="scss">
  @import "styles/v2/colors.scss";

  .malware-protection {
    &__add-chart-item-trigger {
      font-family: Fira Sans;
      font-style: normal;
      font-weight: normal;
      font-size: 15px;
      line-height: 35px;
      text-decoration-line: underline;
      color: $green-medium;
      cursor: pointer;
    }

    .malware-protection__allowed-url, .malware-protection__allowed-file {
      margin-bottom: 10px;
      position: relative;

      &__actions {
        position: absolute;
        right: 10px;
        top: 10px;

        &__action {
          font-size: 16px;
          vertical-align: middle;
          margin-left: 10px;
          cursor: pointer;
        }
      }

      &__file-selection {
        .base-file-input {
          margin-top: 5px;
        }

        &__hash-info {
          font-family: Fira Sans;
          font-style: italic;
          font-weight: 300;
          font-size: 12px;
          margin-top: 5px;
          color: $text-medium;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
        }
      }
    }
  }

</style>
